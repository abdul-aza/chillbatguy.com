import React, { useState, useEffect, useCallback, useMemo } from "react";
import styled from "styled-components";
import { Connection, PublicKey, Transaction, SystemProgram } from "@solana/web3.js";
import { getProvider, signAndSendTransaction, pollSignatureStatus } from "./utils"; // Utility functions you already have

// =============================================================================
// Constants
// =============================================================================

const NETWORK = "https://api.mainnet-beta.solana.com"; // Change to your network
const TOKEN_MINT_ADDRESS = "YOUR_TOKEN_MINT_ADDRESS"; // Replace with $ChillBatGuy token mint address
const provider = getProvider(); // Detect Phantom Wallet
const connection = new Connection(NETWORK);

// =============================================================================
// Styled Components
// =============================================================================

const AppContainer = styled.div`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  font-family: Arial, sans-serif;
`;

// =============================================================================
// Component
// =============================================================================

const GameApp = () => {
  const [logs, setLogs] = useState([]); // For logging actions
  const [publicKey, setPublicKey] = useState(null);

  const createLog = useCallback((status, method, message) => {
    setLogs((logs) => [...logs, { status, method, message }]);
  }, []);

  // Attempt to connect Phantom Wallet
  const connectWallet = useCallback(async () => {
    if (!provider) {
      createLog("error", "connect", "Phantom Wallet not found.");
      alert("Please install Phantom Wallet to continue.");
      return;
    }

    try {
      const connectionResult = await provider.connect();
      setPublicKey(connectionResult.publicKey);
      createLog("success", "connect", `Connected to account: ${connectionResult.publicKey.toBase58()}`);
    } catch (error) {
      createLog("error", "connect", `Failed to connect: ${error.message}`);
    }
  }, [createLog]);

  // Disconnect Wallet
  const disconnectWallet = useCallback(() => {
    if (!provider) return;
    provider.disconnect();
    setPublicKey(null);
    createLog("info", "disconnect", "Disconnected from wallet.");
  }, [createLog]);

  // Handle Game Payment
  const handleGamePayment = useCallback(async (amount) => {
    if (!provider || !publicKey) {
      createLog("error", "payment", "Wallet not connected.");
      alert("Please connect your wallet.");
      return;
    }

    try {
      // Construct transaction for $ChillBatGuy transfer
      const transaction = new Transaction().add(
        SystemProgram.transfer({
          fromPubkey: publicKey,
          toPubkey: "RECIPIENT_PUBLIC_KEY", // Replace with recipient's public key
          lamports: amount, // Replace with token transfer logic for SPL tokens
        })
      );

      createLog("info", "payment", "Creating and signing transaction...");
      const signature = await signAndSendTransaction(provider, transaction);

      createLog("info", "payment", `Transaction sent: ${signature}`);
      pollSignatureStatus(signature, connection, createLog);

      createLog("success", "payment", "Transaction confirmed. Update game logic here.");
    } catch (error) {
      createLog("error", "payment", `Transaction failed: ${error.message}`);
    }
  }, [provider, publicKey, createLog]);

  useEffect(() => {
    if (!provider) return;

    // Attempt to connect automatically if user already approved Phantom
    provider.connect({ onlyIfTrusted: true }).catch(() => {});

    provider.on("connect", (pk) => {
      setPublicKey(pk);
      createLog("success", "connect", `Connected to wallet: ${pk.toBase58()}`);
    });

    provider.on("disconnect", () => {
      setPublicKey(null);
      createLog("info", "disconnect", "Wallet disconnected.");
    });

    return () => {
      provider.disconnect();
    };
  }, [createLog]);

  return (
    <AppContainer>
      <h1>Welcome to $ChillBatGuy Game</h1>
      {!publicKey ? (
        <button onClick={connectWallet}>Connect Phantom Wallet</button>
      ) : (
        <>
          <p>Connected to: {publicKey.toBase58()}</p>
          <button onClick={() => handleGamePayment(1000000)}>Play Game for 1 Token</button>
          <button onClick={disconnectWallet}>Disconnect Wallet</button>
        </>
      )}
      <div>
        <h3>Logs</h3>
        <ul>
          {logs.map((log, index) => (
            <li key={index} style={{ color: log.status === "error" ? "red" : "green" }}>
              {log.method}: {log.message}
            </li>
          ))}
        </ul>
      </div>
    </AppContainer>
  );
};

export default GameApp;
